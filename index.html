<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RealPage Collusion Dashboard</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="photos/berkeleyischool-logo-vertical-blue-sm.png">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Custom Styles -->
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Sidebar styles */
    @media (min-width: 769px) {
      #sidebar-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 250px;
      }
      #page-content-wrapper {
        margin-left: 250px;
      }
      #menu-toggle {
        display: none;
      }
      nav.navbar.fixed-top {
        display: none;
      }
    }
    /* Full-width content sections */
    .section {
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      scroll-snap-align: start;
      transition: opacity 0.6s ease-out, transform 0.6s ease-out;
      opacity: 0;
      transform: translateY(30px);
      padding: 20px;
    }
    .section.in-view {
      opacity: 1;
      transform: translateY(0);
    }
    /* Adjusted chart container height for readability */
    canvas {
      width: 100% !important;
      height: 700px !important;
    }
  </style>
  <!-- Defer non-critical scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js" defer></script>
</head>
<body>
  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-light border-end" id="sidebar-wrapper">
      <div class="sidebar-heading text-center py-4">
        <img src="photos/berkeleyischool-logo-vertical-blue-sm.png" alt="UC Berkeley School of Information">
        <h2 class="mids-capstone">MIDS Capstone: <strong>RealPage Collusion Dashboard</strong></h2>
      </div>
      <div class="list-group list-group-flush">
        <a href="index.html" class="list-group-item list-group-item-action bg-light active">Homepage</a>
        <a href="about.html" class="list-group-item list-group-item-action bg-light">About</a>
        <a href="data-dictionary.html" class="list-group-item list-group-item-action bg-light">Data Dictionary</a>
        <a href="interactive-map.html" class="list-group-item list-group-item-action bg-light">Interactive Map</a>
        <a href="key-findings.html" class="list-group-item list-group-item-action bg-light">Key Findings</a>
        <a href="demo.html" class="list-group-item list-group-item-action bg-light">Try It Yourself: Interactive Modeling</a>
        <a href="contact-us.html" class="list-group-item list-group-item-action bg-light">Contact Us</a>
      </div>
      <div class="p-3">
        <a href="research-paper.pdf" target="_blank" class="btn btn-primary w-100">View Research Paper</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container-fluid">
          <button class="btn btn-secondary" id="menu-toggle">MIDS Capstone, Spring 2025: RealPage Collusion Dashboard</button>
        </div>
      </nav>

      <!-- Introduction Section -->
      <section id="introduction" class="section in-view">
        <div class="text-center w-100">
          <h1>What is Rent, and What Are You Paying For?</h1>
          <img src="photos/intro.jpg" alt="Illustration of rent components" class="img-fluid" style="max-width: 80%; margin: 20px auto;">
          <p>
            Rent is more than just the monthly payment—it reflects the quality of your living space, its location, available amenities, and the competitive market forces at play.
            In this dashboard, we ask: <em>What is rent?</em> <br>
            <em>Why is your rent what it is?</em> <br>
            <em>Why does it vary so much across locations?</em> <br>
            And ultimately, <em>Is RealPage artificially inflating rent prices?</em>
          </p>
          <p>
            Explore the visual story as we break down these questions into data-driven insights.
          </p>
        </div>
      </section>      

      <div class="content">

        <!-- Section 1: What is Rent? -->
        <section id="whatIsRent" class="section">
          <div class="text-center w-100">
            <h1>What is Rent?</h1>
            <p>
              Rent represents the price you pay not only for shelter but also for a host of factors such as building quality, location, amenities, and the overall market demand.
              Here, we start by looking at the available supply—using the average unit count as a proxy—to give context to what shapes your living environment.
            </p>
            <canvas id="explanatoryChart"></canvas>
          </div>
        </section>

        <!-- Section 2: Why is Your Rent What It Is? -->
        <section id="diffinDiff" class="section">
          <div class="text-center w-100">
            <h1>Why is Your Rent What It Is?</h1>
            <p>
              The price of rent is influenced by market events and underlying economic factors.
              This Difference-in-Difference analysis uses the <strong>MPF-ANN-RENT-CHG</strong> metric—aggregated by building year—to show how rent changes over time, particularly before and after key market events.
            </p>
            <canvas id="diffinDiffChart"></canvas>
          </div>
        </section>

        <!-- Section 3: Why is Rent Different in Different Places? -->
        <section id="geoComparison" class="section">
          <div class="text-center w-100">
            <h1>Why Does Rent Vary by Location?</h1>
            <p>
              Local market dynamics, including demand, supply, and regional economic conditions, drive differences in rent.
              The Geographic Rent Index Comparison uses the <strong>MPF-RPSF</strong> metric (average rent per square foot) by state to illustrate how and why rents differ across regions.
            </p>
            <canvas id="geoChart"></canvas>
          </div>
        </section>

        <!-- Section 4: Is Rent Being Inflated? -->
        <section id="correlationTests" class="section">
          <div class="text-center w-100">
            <h1>Is RealPage Inflating Rent Prices?</h1>
            <p>
              The final and most critical question: Could rent prices be artificially inflated? By comparing historical ask rents via the <strong>MPF-HIST-ASK-RENT</strong> metric
              and correlating these values with known RealPage user data, we test whether there is a pattern that suggests collusion.
              Additional benchmark comparisons support this analysis.
            </p>
            <canvas id="correlationChart"></canvas>
          </div>
        </section>

        <!-- Supporting Section: Benchmark Comparison -->
        <section id="benchmarkComparison" class="section">
          <div class="text-center w-100">
            <h1>Benchmark Comparison</h1>
            <p>
              To further our case, we compare multifamily rent indices with single‑family benchmarks.
              This chart uses the <strong>MPF-RPSF</strong> field to show the average rent per square foot and highlights differences in market pricing.
            </p>
            <canvas id="benchmarkChart"></canvas>
          </div>
        </section>

        <!-- Supporting Section: Synthetic Control Robustness -->
        <section id="syntheticControl" class="section">
          <div class="text-center w-100">
            <h1>Robustness Check: Synthetic Control</h1>
            <p>
              As a robustness check, we use synthetic control methods with the <strong>MPF-HIST-ASK-RENT</strong> field to validate our findings across multiple markets.
            </p>
            <canvas id="syntheticChart"></canvas>
          </div>
        </section>

        <!-- Supporting Section: Alternative Rent Measures -->
        <section id="alternativeMeasures" class="section">
          <div class="text-center w-100">
            <h1>Alternative Rent Measures</h1>
            <p>
              We also explore alternative measures of rent using the <strong>unitcount</strong> field, providing another perspective on rent dynamics and further supporting our analysis.
            </p>
            <canvas id="alternativeChart"></canvas>
          </div>
        </section>

        <!-- Supporting Section: Identification of RealPage Buildings -->
        <section id="identificationMethods" class="section">
          <div class="text-center w-100">
            <h1>Identification of RealPage Buildings</h1>
            <p>
              Finally, we use the <strong>unitcount</strong> field to help identify buildings linked to RealPage,
              which assists in determining if certain groups are systematically associated with higher rent pricing.
            </p>
            <canvas id="identificationChart"></canvas>
          </div>
        </section>

      </div>

      <footer class="bg-light text-center py-3 border-top w-100">
        <p class="mb-0">
          &copy; 2025 RealPage Collusion Dashboard &mdash;
          <a href="privacy.html">View Full Privacy Policy</a>
        </p>
      </footer>
    </div>
    <!-- /#page-content-wrapper -->
  </div>

  <!-- Inline Script: Initialize Charts and Load Data -->
  <script defer>
    let charts = {};
    let csvData = [];
    // Arrays for state-level aggregation (for bar charts)
    let csvLabels = [];
    let unitCountData = [];
    let mpfRpsfData = [];
    let mpfHistAskRentData = [];
    let mpfAnnRentChgData = [];
    // Arrays for yearBuilt aggregation (for line/scatter charts)
    let yearLabels = [];
    let unitCountYearData = [];
    let mpfRpsfYearData = [];
    let mpfHistAskRentYearData = [];
    let mpfAnnRentChgYearData = [];
    // Track chart initialization per section
    let chartsInitialized = {
      whatIsRent: false,
      diffinDiff: false,
      benchmarkComparison: false,
      syntheticControl: false,
      alternativeMeasures: false,
      geoComparison: false,
      correlationTests: false,
      identificationMethods: false
    };

    // Mapping: labels include the CSV field name.
    const sectionMetrics = {
      whatIsRent: { metric: 'unitcount', label: 'Avg Unit Count (Field: unitcount)' },
      diffinDiff: { metric: 'MPF-ANN-RENT-CHG', label: 'Avg Annual Rent Change (Field: MPF-ANN-RENT-CHG)' },
      benchmarkComparison: { metric: 'MPF-RPSF', label: 'Avg Rent per Sq Ft (Field: MPF-RPSF)' },
      syntheticControl: { metric: 'MPF-HIST-ASK-RENT', label: 'Avg Historical Ask Rent (Field: MPF-HIST-ASK-RENT)' },
      alternativeMeasures: { metric: 'unitcount', label: 'Avg Unit Count (Alt.) (Field: unitcount)' },
      geoComparison: { metric: 'MPF-RPSF', label: 'Avg Rent per Sq Ft (Field: MPF-RPSF)' },
      correlationTests: { metric: 'MPF-HIST-ASK-RENT', label: 'Avg Historical Ask Rent (Field: MPF-HIST-ASK-RENT)' },
      identificationMethods: { metric: 'unitcount', label: 'Avg Unit Count (Field: unitcount)' }
    };

    // Aggregate CSV data by state (for bar charts)
    function aggregateByState() {
      let stateAgg = {};
      csvData.forEach(row => {
        let state = row.state;
        if (state) {
          if (!stateAgg[state]) {
            stateAgg[state] = {
              unitcountSum: 0,
              mpfRpsfSum: 0,
              mpfHistAskRentSum: 0,
              mpfAnnRentChgSum: 0,
              count: 0
            };
          }
          stateAgg[state].unitcountSum += parseFloat(row.unitcount) || 0;
          stateAgg[state].mpfRpsfSum += parseFloat(row["MPF-RPSF"]) || 0;
          stateAgg[state].mpfHistAskRentSum += parseFloat(row["MPF-HIST-ASK-RENT"]) || 0;
          stateAgg[state].mpfAnnRentChgSum += parseFloat(row["MPF-ANN-RENT-CHG"]) || 0;
          stateAgg[state].count += 1;
        }
      });
      csvLabels = Object.keys(stateAgg);
      unitCountData = [];
      mpfRpsfData = [];
      mpfHistAskRentData = [];
      mpfAnnRentChgData = [];
      csvLabels.forEach(state => {
        let agg = stateAgg[state];
        unitCountData.push(agg.unitcountSum / agg.count);
        mpfRpsfData.push(agg.mpfRpsfSum / agg.count);
        mpfHistAskRentData.push(agg.mpfHistAskRentSum / agg.count);
        mpfAnnRentChgData.push(agg.mpfAnnRentChgSum / agg.count);
      });
    }

    // Aggregate CSV data by yearBuilt (for line/scatter charts)
    function aggregateByYear() {
      let yearAgg = {};
      csvData.forEach(row => {
        let year = row.yearBuilt;
        if (year) {
          if (!yearAgg[year]) {
            yearAgg[year] = { 
              unitcountSum: 0, 
              mpfRpsfSum: 0, 
              mpfHistAskRentSum: 0, 
              mpfAnnRentChgSum: 0, 
              count: 0 
            };
          }
          yearAgg[year].unitcountSum += parseFloat(row.unitcount) || 0;
          yearAgg[year].mpfRpsfSum += parseFloat(row["MPF-RPSF"]) || 0;
          yearAgg[year].mpfHistAskRentSum += parseFloat(row["MPF-HIST-ASK-RENT"]) || 0;
          yearAgg[year].mpfAnnRentChgSum += parseFloat(row["MPF-ANN-RENT-CHG"]) || 0;
          yearAgg[year].count += 1;
        }
      });
      let years = Object.keys(yearAgg).sort();
      let unitData = [], rpsfData = [], histAskData = [], annRentChgData = [];
      years.forEach(year => {
        let agg = yearAgg[year];
        unitData.push(agg.unitcountSum / agg.count);
        rpsfData.push(agg.mpfRpsfSum / agg.count);
        histAskData.push(agg.mpfHistAskRentSum / agg.count);
        annRentChgData.push(agg.mpfAnnRentChgSum / agg.count);
      });
      yearLabels = years;
      unitCountYearData = unitData;
      mpfRpsfYearData = rpsfData;
      mpfHistAskRentYearData = histAskData;
      mpfAnnRentChgYearData = annRentChgData;
    }

    // Helper: Get chart data based on aggregation type.
    // For line/scatter charts, use year-based data; for bar charts, use state-based data.
    function getChartData(metric, chartType) {
      if (chartType === 'line' || chartType === 'scatter') {
        switch(metric) {
          case 'unitcount': return { labels: yearLabels, data: unitCountYearData };
          case 'MPF-RPSF': return { labels: yearLabels, data: mpfRpsfYearData };
          case 'MPF-HIST-ASK-RENT': return { labels: yearLabels, data: mpfHistAskRentYearData };
          case 'MPF-ANN-RENT-CHG': return { labels: yearLabels, data: mpfAnnRentChgYearData };
          default: return { labels: yearLabels, data: [] };
        }
      } else {
        switch(metric) {
          case 'unitcount': return { labels: csvLabels, data: unitCountData };
          case 'MPF-RPSF': return { labels: csvLabels, data: mpfRpsfData };
          case 'MPF-HIST-ASK-RENT': return { labels: csvLabels, data: mpfHistAskRentData };
          case 'MPF-ANN-RENT-CHG': return { labels: csvLabels, data: mpfAnnRentChgData };
          default: return { labels: csvLabels, data: [] };
        }
      }
    }

    // Initialize a Chart.js chart.
    function initChart(ctxId, chartType, label, data, labels, extraOptions = {}) {
      const ctx = document.getElementById(ctxId).getContext('2d');
      return new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            fill: false,
            borderColor: 'rgba(75, 192, 192, 1)',
            tension: 0.1,
            backgroundColor: chartType === 'bar' ? 'rgba(75, 192, 192, 0.2)' : undefined,
            borderWidth: chartType === 'bar' ? 1 : undefined
          }]
        },
        options: Object.assign({
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 0 },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            tooltip: { 
              enabled: true, 
              bodyFont: { size: 16 },
              callbacks: {
                label: function(context) {
                  if (chartType === 'scatter') {
                    return 'Year: ' + context.raw.x + ', Value: ' + context.raw.y;
                  } else {
                    return context.dataset.label + ": " + context.parsed.y;
                  }
                }
              }
            },
            legend: { display: true, labels: { font: { size: 16 } } }
          },
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 20, font: { size: 14 } } },
            y: { ticks: { font: { size: 14 } } }
          }
        }, extraOptions)
      });
    }

    // Update function to refresh charts after CSV data loads.
    function updateAllCharts() {
      // Update Difference-in-Difference:
      if (charts.diffinDiff) {
        let dtDiff = getChartData(sectionMetrics.diffinDiff.metric, 'line');
        charts.diffinDiff.data.labels = dtDiff.labels;
        charts.diffinDiff.data.datasets[0].data = dtDiff.data;
        charts.diffinDiff.update();
      }

      // Update Correlation Tests:
      if (charts.correlation) {
        let dtCorr = getChartData(sectionMetrics.correlationTests.metric, 'scatter');
        let scatterData = dtCorr.labels.map((year, idx) => ({ x: parseFloat(year), y: dtCorr.data[idx] }));
        charts.correlation.data.datasets[0].data = scatterData;
        charts.correlation.update();
      }
      // (Optional) update other charts similarly if needed.
    }

    // Initialize charts for each section when they come into view.
    function initializeSection(sectionId) {
      if (!chartsInitialized[sectionId]) {
        chartsInitialized[sectionId] = true;
        let metric = sectionMetrics[sectionId].metric;
        let chartType;
        switch (sectionId) {
          case "whatIsRent":
            chartType = 'line';
            let dtEx = getChartData(metric, chartType);
            charts.whatIsRent = initChart('explanatoryChart', chartType, 'What is Rent? ' + sectionMetrics.whatIsRent.label, dtEx.data, dtEx.labels);
            break;
          case "diffinDiff":
            chartType = 'line';
            let dtDiff = getChartData(metric, chartType);
            charts.diffinDiff = initChart('diffinDiffChart', chartType, 'Why is Your Rent What It Is? ' + sectionMetrics.diffinDiff.label, dtDiff.data, dtDiff.labels, {
              scales: {
                x: { title: { display: true, text: 'Year Built' }, ticks: { font: { size: 14 } } },
                y: { title: { display: true, text: 'MPF-ANN-RENT-CHG' }, ticks: { font: { size: 14 } } }
              }
            });
            break;
          case "benchmarkComparison":
            chartType = 'bar';
            let dtBench = getChartData(metric, chartType);
            charts.benchmark = initChart('benchmarkChart', chartType, 'Benchmark Comparison: ' + sectionMetrics.benchmarkComparison.label, dtBench.data, dtBench.labels);
            break;
          case "syntheticControl":
            chartType = 'line';
            let dtSynth = getChartData(metric, chartType);
            charts.synthetic = initChart('syntheticChart', chartType, 'Synthetic Control: ' + sectionMetrics.syntheticControl.label, dtSynth.data, dtSynth.labels);
            break;
          case "alternativeMeasures":
            chartType = 'bar';
            let dtAlt = getChartData(metric, chartType);
            charts.alternative = initChart('alternativeChart', chartType, 'Alternative Rent Measures: ' + sectionMetrics.alternativeMeasures.label, dtAlt.data, dtAlt.labels);
            break;
          case "geoComparison":
            chartType = 'line';
            let dtGeo = getChartData(metric, chartType);
            charts.geo = initChart('geoChart', chartType, 'Geographic Rent Comparison: ' + sectionMetrics.geoComparison.label, dtGeo.data, dtGeo.labels);
            break;
          case "correlationTests":
            chartType = 'scatter';
            let dtCorr = getChartData(metric, chartType);
            let scatterData = dtCorr.labels.map((year, idx) => ({ x: parseFloat(year), y: dtCorr.data[idx] }));
            charts.correlation = initChart('correlationChart', chartType, 'Is Rent Being Inflated? ' + sectionMetrics.correlationTests.label, scatterData, [], {
              scales: {
                x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Year' } },
                y: { beginAtZero: true, title: { display: true, text: sectionMetrics.correlationTests.label } }
              },
              parsing: false
            });
            break;
          case "identificationMethods":
            chartType = 'bar';
            let dtIdent = getChartData(metric, chartType);
            charts.identification = initChart('identificationChart', chartType, 'Identification Methods: ' + sectionMetrics.identificationMethods.label, dtIdent.data, dtIdent.labels);
            break;
        }
      }
    }

    // Use IntersectionObserver to initialize sections when they come into view.
    document.addEventListener("DOMContentLoaded", function() {
      const sections = document.querySelectorAll('.section');
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('in-view');
            initializeSection(entry.target.id);
          }
        });
      }, { threshold: 0.4 });
      sections.forEach(section => observer.observe(section));
    });

    // Load CSV data and perform aggregations.
    document.addEventListener("DOMContentLoaded", function() {
      fetch('https://rpc-webpage.s3-accelerate.amazonaws.com/cbsa_data.csv')
        .then(response => response.text())
        .then(csvText => {
          Papa.parse(csvText, {
            header: true,
            complete: function(results) {
              csvData = results.data;
              aggregateByState();
              aggregateByYear();
              // Update charts now that the data has been loaded and aggregated.
              updateAllCharts();
            }
          });
        })
        .catch(error => console.error("Error loading CSV data:", error));
    });

    // Sidebar toggle for mobile.
    document.addEventListener("DOMContentLoaded", function() {
      const menuToggle = document.getElementById("menu-toggle");
      const wrapper = document.getElementById("wrapper");
      menuToggle.addEventListener("click", () => {
        wrapper.classList.toggle("toggled");
      });
    });
  </script>
</body>
</html>
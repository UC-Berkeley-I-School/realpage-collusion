<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Try It Yourself: Interactive Modeling</title>
  <link rel="icon" type="image/png" href="photos/berkeleyischool-logo-vertical-blue-sm.png">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
    <div class="bg-light border-end" id="sidebar-wrapper">
      <div class="sidebar-heading text-center py-4">
        <img src="photos/berkeleyischool-logo-vertical-blue-sm.png" alt="UC Berkeley School of Information">
        <h2 class="mids-capstone">
          MIDS Capstone: <strong>RealPage Collusion Dashboard</strong>
        </h2>
      </div>
      <div class="list-group list-group-flush">
        <a href="index.html" class="list-group-item list-group-item-action bg-light">
          Homepage
        </a>
        <a href="about.html" class="list-group-item list-group-item-action bg-light">About</a>
        <a href="data-dictionary.html" class="list-group-item list-group-item-action bg-light">Data Dictionary</a>
        <a href="interactive-map.html" class="list-group-item list-group-item-action bg-light">Interactive Map</a>
        <a href="key-findings.html" class="list-group-item list-group-item-action bg-light">Key Findings</a>
        <a href="demo.html" class="list-group-item list-group-item-action bg-light active">Try It Yourself: Interactive Modeling</a>
        <a href="contact-us.html" class="list-group-item list-group-item-action bg-light">Contact Us</a>
      </div>
      <div class="p-3">
        <a href="research-paper.pdf" target="_blank" class="btn btn-primary w-100">View Research Paper</a>
      </div>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
      <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom mobile-only">
        <div class="container-fluid">
          <button class="btn btn-secondary" id="menu-toggle">MIDS Capstone, Spring 2025: RealPage Collusion Dashboard</button>
        </div>
      </nav>

      <div class="container-fluid py-4">
        <h1 class="display-5 mb-4">Try It Yourself: Interactive Modeling</h1>
        <p class="text-muted">
          Use the input fields below to provide the model inputs. The model will analyze your inputs to predict outcomes using both collusion and no-collusion models. After submission, you'll receive prediction results along with key evaluation metrics and a visualization.
        </p>        

        <!-- Form for Inputs -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Model Inputs</h5>
          </div>
          <div class="card-body">
            <form id="model-form">
              <div class="mb-3">
                <label for="yearBuilt" class="form-label">
                  Year Built
                  <span data-bs-toggle="tooltip" title="Construction year of the building. Helps identify vintage or newer properties.">ⓘ</span>
                </label>
                <input type="number" class="form-control" id="yearBuilt" name="yearBuilt" placeholder="e.g. 1998" required>
              </div>
              <div class="mb-3">
                <label for="unitcount" class="form-label">
                  Unit Count
                  <span data-bs-toggle="tooltip" title="Total number of rental units in the property.">ⓘ</span>
                </label>
                <input type="number" class="form-control" id="unitcount" name="unitcount" placeholder="e.g. 120" required>
              </div>
              <div class="mb-3">
                <label for="MPF-HIST-CONC-RATIO" class="form-label">
                  MPF Historical Concentration Ratio
                  <span data-bs-toggle="tooltip" title="Market concentration metric. Closer to 1 means fewer players dominate.">ⓘ</span>
                </label>
                <input type="number" class="form-control" id="MPF-HIST-CONC-RATIO" name="MPF-HIST-CONC-RATIO" step="any" placeholder="e.g. 0.45" required>
              </div>
              <div class="mb-3">
                <label for="MPF-OCC" class="form-label">
                  MPF Occupancy
                  <span data-bs-toggle="tooltip" title="Current occupancy rate. Typically ranges from 0.8 to 1.0.">ⓘ</span>
                </label>
                <input type="number" class="form-control" id="MPF-OCC" name="MPF-OCC" step="any" placeholder="e.g. 0.92" required>
              </div>
              <div class="mb-3">
                <label for="city" class="form-label">
                  City / Submarket
                  <span data-bs-toggle="tooltip" title="Enter a recognizable city or submarket name (e.g. Austin, TX or Bay Area South)">ⓘ</span>
                </label>
                <input type="text" class="form-control" id="city" name="city" list="city-suggestions" placeholder="e.g. Austin, TX" required>
                <datalist id="city-suggestions"></datalist>
              </div>
              <div class="mb-3">
                <label for="cbsa" class="form-label">
                  CBSA Code
                  <span data-bs-toggle="tooltip" title="Optional: Enter a 5-digit Core-Based Statistical Area (CBSA) code if known. This can improve geographic targeting.">ⓘ</span>
                </label>
                <input type="text" class="form-control" id="cbsa" name="cbsa" placeholder="e.g. 12420 (Austin-Round Rock, TX)">
              </div>           
              <div class="mb-3">
                <label for="stories" class="form-label">
                  Stories
                  <span data-bs-toggle="tooltip" title="Number of floors in the building. Helps determine building type and density.">ⓘ</span>
                </label>
                <input type="number" class="form-control" id="stories" name="stories" placeholder="e.g. 3" required>
              </div>
              <button type="submit" class="btn btn-primary">Submit &amp; Predict</button>
            </form> 
            <script>
              const cityInput = document.getElementById('city');
              const citySuggestions = document.getElementById('city-suggestions');
              let cityTimeout = null;
            
              cityInput.addEventListener('input', () => {
                clearTimeout(cityTimeout);
                const query = cityInput.value.trim();
                if (query.length < 3) return;
            
                cityTimeout = setTimeout(async () => {
                  try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                    const results = await res.json();
            
                    citySuggestions.innerHTML = '';
                    results.forEach(result => {
                      const cityLabel = result.display_name;
                      const option = document.createElement('option');
                      option.value = cityLabel;
                      citySuggestions.appendChild(option);
                    });
                  } catch (err) {
                    console.error('Autocomplete error:', err);
                  }
                }, 300); // delay to reduce API hits
              });
            </script>                                 
          </div>
        </div>

        <!-- Display Model Output (text) -->
        <div id="model-output" class="alert alert-info d-none" role="alert"></div>

        <!-- Visualization Container (hidden by default) -->
        <div class="desktop-only card mb-4 d-none" id="prediction-vis-container">
          <div class="card-header">
            <h5 class="mb-0">Prediction-based Visualization</h5>
          </div>
          <div class="card-body">
            <p class="mb-3 text-muted">Below is a visualization relevant to your model results.</p>
            <!-- Container for iframe graph -->
            <div id="iframe-container" class="ratio ratio-16x9 d-none">
              <iframe src="" id="prediction-iframe" frameborder="0" allowfullscreen></iframe>
            </div>
            <!-- Container for Chart.js graph -->
            <div id="chart-container" class="d-none">
              <canvas id="prediction-chart"></canvas>
            </div>
          </div>
        </div>

      </div>
      <footer class="bg-light text-center py-3 mt-5 border-top">
        <p class="mb-0">&copy; 2025 RealPage Collusion Dashboard &mdash; <a href="privacy.html">View Full Privacy Policy</a></p>
      </footer>
    </div>
    <!-- /#page-content-wrapper -->
  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Initialize Bootstrap tooltips -->
  <script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    });
  </script>

  <!-- Script to toggle the sidebar -->
  <script>
    const menuToggle = document.getElementById("menu-toggle");
    const wrapper = document.getElementById("wrapper");
    menuToggle.addEventListener("click", () => {
      wrapper.classList.toggle("toggled");
    });
  </script>

  <!-- Script to handle the form submission and display prediction-based visualization -->
  <script>
    const form = document.getElementById('model-form');
    const outputDiv = document.getElementById('model-output');
    const visContainer = document.getElementById('prediction-vis-container');
    const iframeContainer = document.getElementById('iframe-container');
    const chartContainer = document.getElementById('chart-container');
    const visIframe = document.getElementById('prediction-iframe');
    let predictionChart = null;
  
    // ✅ Helper: Geocode city into lat/lng
    async function getLatLongFromCity(city) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data = await response.json();
      if (data && data.length > 0) {
        return {
          latitude: parseFloat(data[0].lat),
          longitude: parseFloat(data[0].lon)
        };
      } else {
        throw new Error('Location not found');
      }
    }
  
    form.addEventListener('submit', async event => {
      event.preventDefault();
  
      const city = document.getElementById('city').value.trim();
  
      try {
        const { latitude, longitude } = await getLatLongFromCity(city);
  
        const payload = {

            yearBuilt: parseInt(document.getElementById('yearBuilt').value),
            unitcount: parseInt(document.getElementById('unitcount').value),
            "MPF-HIST-CONC-RATIO": parseFloat(document.getElementById('MPF-HIST-CONC-RATIO').value),
            "MPF-OCC": parseFloat(document.getElementById('MPF-OCC').value),
            latitude,
            longitude,
            cbsa: document.getElementById('cbsa').value.trim() || null,
            stories: parseInt(document.getElementById('stories').value)
        };
  
        outputDiv.classList.add('d-none');
        outputDiv.classList.remove('alert-danger');
        visContainer.classList.add('d-none');
        visIframe.src = "";
        iframeContainer.classList.add('d-none');
        chartContainer.classList.add('d-none');
        if (predictionChart) {
          predictionChart.destroy();
          predictionChart = null;
        }
  
        const response = await fetch('https://67bcba9fed4861e07b3bbb1a.mockapi.io/rpc/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
  
        //const data = await response.json();
        const data = {
          prediction_realpage: 1.92,
          prediction_non_realpage: 1.73,
          mse: 0.12,
          confidence: 88,
          accuracy: 91,
          precision: 0.87,
          recall: 0.78,
          f1Score: 0.82,
          mae: 0.09,
          rSquared: 0.89,
          aucRoc: 0.93,
          logLoss: 0.11,
          pValues: { "yearBuilt": 0.032, "unitcount": 0.005 },
          tStats: { "yearBuilt": 2.15, "unitcount": 3.88 }
        };
        console.log(data);

        let interpretation = '';
        if (data.prediction_realpage > data.prediction_non_realpage) {
          interpretation = `<div class="alert alert-warning fw-bold">
            ⚠️ Evidence of Potential Collusion: RealPage-affiliated prediction is higher than non-RealPage.
          </div>`;
        } else {
          interpretation = `<div class="alert alert-success fw-bold">
            ✅ No Evidence of Collusion: RealPage-affiliated prediction is not higher.
          </div>`;
        };
        console.log(interpretation);
        let outputHTML = `
          <strong><span data-bs-toggle="tooltip" title="Predicted monthly rent per square foot using RealPage-affiliated model.">RealPage RPSF:</span></strong>
          <span class="text-success fw-bold">$${data.prediction_realpage.toFixed(2)} (RealPage)</span> <br>
          <strong><span data-bs-toggle="tooltip" title="Predicted monthly rent per square foot using non-RealPage model.">Non-RealPage RPSF:</span></strong>
          <span class="text-secondary fw-bold">$${data.prediction_non_realpage.toFixed(2)} (Non-RealPage)</span> <br>
          <hr>
          ${interpretation}
          <hr> 
          ${data.mse !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The average of the squared differences between the predicted and actual values. Lower values indicate better predictive accuracy.">MSE:</span></strong> <span>${data.mse}</span> <br>` : ""}
          ${data.confidence !== undefined ? `<strong><span data-bs-toggle="tooltip" title="How certain the model is about its prediction.">Confidence:</span></strong> <span>${data.confidence}%</span> <br>` : ""}
          ${data.accuracy !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The percentage of correct predictions out of all predictions made.">Accuracy:</span></strong> <span>${data.accuracy}%</span> <br>` : ""}
          ${data.precision !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The proportion of true positive predictions among all positive predictions made.">Precision:</span></strong> <span>${data.precision}</span> <br>` : ""}
          ${data.recall !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The proportion of actual positives that were correctly identified by the model.">Recall:</span></strong> <span>${data.recall}</span> <br>` : ""}
          ${data.f1Score !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The harmonic mean of precision and recall.">F1-Score:</span></strong> <span>${data.f1Score}</span> <br>` : ""}
          ${data.mae !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The average absolute difference between predicted values and actual values. Lower values indicate more accurate predictions.">MAE:</span></strong> <span>${data.mae}</span> <br>` : ""}
          ${data.rSquared !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The coefficient of determination showing the proportion of variance explained by the model. Closer to 1 indicates a better fit.">R² Score:</span></strong> <span>${data.rSquared}</span> <br>` : ""}
          ${data.aucRoc !== undefined ? `<strong><span data-bs-toggle="tooltip" title="The area under the Receiver Operating Characteristic curve. Higher values indicate a better ability to distinguish between classes.">AUC-ROC:</span></strong> <span>${data.aucRoc}</span> <br>` : ""}
          ${data.logLoss !== undefined ? `<strong><span data-bs-toggle="tooltip" title="A metric that penalizes false classifications. Lower values indicate a more accurate model.">Log Loss:</span></strong> <span>${data.logLoss}</span> <br>` : ""}
          ${data.pValues !== undefined ? `<hr><strong>Feature P-Values:</strong><br>${Object.entries(data.pValues).map(([k, v]) => `<span>${k}:</span> <span>${v.toFixed(4)}</span>`).join("<br>")}<br>` : ""}
          ${data.tStats !== undefined ? `<hr><strong>Feature T-Statistics:</strong><br>${Object.entries(data.tStats).map(([k, v]) => `<span>${k}:</span> <span>${v.toFixed(4)}</span>`).join("<br>")}<br>` : ""}
        `;
        outputDiv.innerHTML = outputHTML;
        outputDiv.classList.remove('d-none');  // <-- move this here just in case
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
  
        if (data.visualUrl) {
          iframeContainer.classList.remove('d-none');
          chartContainer.classList.add('d-none');
          visIframe.src = data.visualUrl;
          visContainer.classList.remove('d-none');
        } else if (data.xAxis && data.yAxis) {
          iframeContainer.classList.add('d-none');
          chartContainer.classList.remove('d-none');
          visContainer.classList.remove('d-none');

          const ctx = document.getElementById('prediction-chart').getContext('2d');

          // Choose chart type based on data.chartType
          const chartTitle = data.chartType === "feature_vs_prediction"
            ? "Feature Impact on Prediction"
            : "Actual vs. Predicted Rent";

          predictionChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: data.xAxis,
              datasets: data.yAxis.map(series => ({
                label: series.label,
                data: series.data,
                borderColor: series.borderColor || 'rgba(75, 192, 192, 1)',
                fill: false,
                tension: 0.1,
                borderWidth: 1
              }))
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true },
                title: {
                  display: true,
                  text: chartTitle,
                  font: { size: 16 }
                }
              },
              scales: {
                y: {
                  title: {
                    display: true,
                    text: data.chartType === "feature_vs_prediction" ? "Predicted Rent" : "Rent"
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: data.chartType === "feature_vs_prediction" ? data.featureName || "Feature" : "Sample Index"
                  }
                }
              }
            }
          });
        }
        else {
          visContainer.classList.add('d-none');
        }
      } catch (err) {
        outputDiv.classList.remove('d-none');
        outputDiv.classList.add('alert-danger');
        outputDiv.textContent = 'Error fetching prediction or geocoding city. Please try again.';
        console.error(err);
      }
    });
  </script>  
</body>
</html>